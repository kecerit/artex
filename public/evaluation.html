<!doctype html>
<title>Evaluation</title>
<!-- JQUERY UI STARTS -->
<link type="text/css" href="lib/jqueryui/css/ui-lightness/jquery-ui-1.8.20.custom.css" rel="Stylesheet" />
<script src="lib/jqueryui/js/jquery-1.7.2.min.js" charset="utf-8"></script>
<script src="lib/jqueryui/js/jquery-ui-1.8.20.custom.min.js" charset="utf-8"></script>
<!-- JQUERY UI ENDS -->

<!-- To avoid: "attempt to run compile-and-go script on a cleared scope" -->
<script src="CF/ChernoffFacesSimple.js" charset="utf-8"></script>

<link rel="stylesheet" type="text/css" href="css/iframe.css">
<link rel="stylesheet" type="text/css" href="css/evaluation.css">

<body>
  <h2>Evaluation</h2>
  Express a quality judgement on the paintings just made by other players. Move the slider on a scale from 0 to 10,  where
  <ul>
    <li> 0 (zero) means <em>complete dislike</em> </li>
    <li> 5 (five) means that you are <em>indifferent</em> </li>
    <li> 10 (ten) means <em>complete like</em> </li>
  </ul>
  <p>
    The same paintings will be reviewed also by other players, and each painting that
    will receive an average evaluation greater than <strong>5.00 (five)</strong>
    will be put on display.
  </p>
  <div id="container_evaluation"></div>
  <div id="container_done">
    <div id="done_box" >
      <button onclick='javascript:parent.node.done();'>Click here when you are done</button>
    </div>
  </div>

</body>

<script type="text/javascript">
    <!--

  window.onload = function(){

      var node = parent.node,
      JSUS = parent.JSUS,
      W = parent.W,
      Table = W.Table;

      var table;

      // Avoid ESC to break the connection
      W.noEscape(window);

      table = new Table({
          id: 'tbl_evaluation',
      });
      
      document.getElementById('container_evaluation').appendChild(table.table);

      node.on.data('CF', function(msg) {
          var cf_options, cf;
          var display, display_container, sl;
          var author, evaId, displayEvaId, displayContId;
          var jQuerySlider;
          var labelText;

          var headers;          
          var ex, i, len;

          console.log('RECEIVED CF ********************');

          if (!msg.data) {
              node.err('Error: No data received on CF.');
              return;
          }

          headers = [];

          cf_options = {
              width: 300,
              height: 300,
              scaleX: 1,
              scaleY: 1,
              id: false,
              change: false,
              controls: false
          };

          i = -1, len = node.game.nExhibits;

          // TODO: each exhibit can have multiple image
          // so we need a nested for, or we access A, B, C directly.

          for ( ; ++i < len ; ) {

              ex = node.game.exhibitNames[i];
              data = msg.data[ex];
              
              // Add image if any is found.
              if (!data || !data.length) continue;

              // Create Chernoff face.
              cf_options.features = data.face;
              cf = node.widgets.get('ChernoffFaces', cf_options);
              
              // Create Evaluation interface.
              author = data.author;
              evaId = 'eva_' + author;
              diplayEvaId = 'display_' + author;
              displayContId = 'display_cont_' + author;
              
              // Add the slider to the container.
              sl = W.getDiv(evaId);
              display_container = W.getDiv(displayContId);
              display = W.addTextInput(display_container, diplayEvaId, {
                  disabled: "disabled",
                  className: 'curr-eva-input'
              });
              
              labelText = 'Your current evaluation: ';
              W.addLabel(display_container, display, null, labelText);
              
              node.game.evas[author] = display;
              
              headers.push('Review for Exhibition: ' + ex);
            
              table.addColumn([sl, display_container, cf.getCanvas()]);
                            
              // Add jquery slider.
              jQuerySlider = $("#" + evaId);
              
              jQuerySlider.slider({
                  value: 5,
                  min: 0,
                  max: 10,
                  step: 0.1,
                  slide: function( event, ui ) {
                      $("#" + diplayEvaId ).val( ui.value );
                      node.game.evasChanged[author] = true;
                  }
              });
              $("#" + diplayEvaId).val($("#" + evaId).slider("value"));
              
              // AUTOPLAY.
              node.env('auto', function() {
                  node.timer.randomExec(function() {
                      $("#" + evaId).slider("value", Math.random() * 10);
                      $("#" + diplayEvaId ).val($("#" + evaId).slider("value"));
                  }, 4000);
              });
          }

          table.setHeader(headers);
          table.parse();
      });


      node.env('auto', function(){
          node.timer.randomExec(function() {
              node.done();
          }, 10000);
      });
  }

  //-->
</script>
